%% current
\pdfminorversion=4 % force pdf 1.4 output; http://tex.stackexchange.com/questions/95973/is-pdftex-1-40-13-outputting-malformed-pdfs
\RequirePackage{pdf14}% workaround for a bug in older pdftex; http://tex.stackexchange.com/a/87946/6853
\NeedsTeXFormat{LaTeX2e}
\ProvidesClass{problems}
\LoadClass[twocolumn]{book}
\usepackage[paperwidth=8.5in,paperheight=11in]{geometry}
\usepackage{shaddap,lmmath,amsmath,amssymb,cancel,titlesec,ifthen,makeidx,graphicx,url,moreverb,multirow}
% moreverb provides listing environment
\usepackage{timetravel}
%
\newcommand{\intro}[1]{\emph{#1}}
%%%%%%%%%%%%%%%%% sectioning %%%%%%%%%%%%%
% The following two lines get rid of extra whitespace before chapter headings. http://tex.stackexchange.com/questions/39988/space-before-chapters-and-contents
\titleformat{\chapter}[display]{\normalfont\huge\bfseries}{\chaptertitlename\ \thechapter}{20pt}{\Huge}
\titlespacing*{\chapter}{0pt}{0pt}{10pt} % left, above, below
%%%%%%%%%%%%%%%%% math %%%%%%%%%%%%%%%%%%%
\newcommand{\eqquad}{}
\renewcommand{\mygamma}{\gamma}
\newcommand{\eqnimage}[1]{\raisebox{-.2\height}{\includegraphics[resolution=300]{utility-figs/#1}}}
% used in two-point-five-kids
% also defined in SN ch. 14
%%%%%%%%%%%%%%%%% figures %%%%%%%%%%%%%%%%%%%
% When making a figure by hand (e.g., in the main text), typically use \fignarrow.
% Typically such a figure would be in a location such as share/mechanics/figs.
\newcommand{\docred}[3]{\textbf{#1} \emph{#2:} #3.\quad}
\newcommand{\cred}[3]{\docred{\pageref{fig:#1}}{#2}{#3}}
\newcommand{\sharedfigs}{}% gets redefined, typically for each chapter, by .tex generated by generate_problems.rb
\newcommand{\anonymousinlinefig}[1]{\includegraphics{#1}}
\newcommand{\figraw}[4]%
  % #1=placement (ignored), #2=file, #3=caption, #4=width
  {%
    \begin{figure}[h]
    \begin{center}\includegraphics[#4]{../../\sharedfigs/#2}\end{center}
    \caption[]{#3}\label{fig:#2} % empty [] is a workaround for this bug: http://tex.stackexchange.com/a/227840/6853
    \end{figure}
  }
\newcommand{\figrawpath}[5]%
  % #1=placement (ignored), #2=file, #3=caption, #4=width, #5=bare name
  {%
    \begin{figure}[h]
    \begin{center}\includegraphics[#4]{#2}\end{center}
    \caption[]{#3}\label{fig:#5} % empty [] is a workaround for this bug: http://tex.stackexchange.com/a/227840/6853
    \end{figure}
  }
% The following is always placed inside a timetravel environment.
\newcommand{\figrawwidepath}[5]%
  % #1=placement (ignored), #2=file, #3=caption, #4=width, #5=bare name
  {%
    \begin{figure*}[]
    \begin{center}\includegraphics[#4]{#2}\end{center}
    \caption[]{#3}\label{fig:#5} % empty [] is a workaround for this bug: http://tex.stackexchange.com/a/227840/6853
    \end{figure*}
  }
\newcommand{\figrawanon}[4]%
  % #1=placement (ignored), #2=file, #3=caption, #4=width
  {%
    \begin{figure}[h]
    \begin{center}\includegraphics[#4]{../../\sharedfigs/#2}\\#3\end{center}
    \label{fig:#2} % empty [] is a workaround for this bug: http://tex.stackexchange.com/a/227840/6853
    \end{figure}
  }
\newcommand{\figrawpathanon}[4]%
  % #1=placement (ignored), #2=file, #3=caption, #4=width
  {%
    \begin{figure}[h]
    \begin{center}\includegraphics[#4]{#2}\\#3\end{center}
    \end{figure}
  }
% The following is always placed inside a timetravel environment.
\newcommand{\figrawwidepathanon}[5]%
  % #1=placement (ignored), #2=file, #3=caption, #4=width, #5=bare name
  {%
    \begin{figure*}[]
    \begin{center}\includegraphics[#4]{#2}\\#3\end{center}
    \label{fig:#5} % empty [] is a workaround for this bug: http://tex.stackexchange.com/a/227840/6853
    \end{figure*}
  }
\newcommand{\figrawwide}[4]{\figrawwidepath{#1}{../../\sharedfigs/#2}{#3}{#4}{#2}}
\newcommand{\figrawwideanon}[4]{\figrawwidepathanon{#1}{../../\sharedfigs/#2}{#3}{#4}{#2}}
\newcommand{\fig}[3]{\figraw{#2}{#1}{#3}{width=0.5\textwidth}} % file, placement (ignored), caption
\newcommand{\figpath}[4]{\figrawpath{#2}{#1}{#3}{width=0.5\textwidth}{#4}}
\newcommand{\figanon}[3]{\figrawanon{#2}{#1}{#3}{width=0.5\textwidth}} % file, placement (ignored), caption
\newcommand{\figpathanon}[3]{\figrawpathanon{#2}{#1}{#3}{width=0.5\textwidth}} % file, placement (ignored), caption
\newcommand{\fignarrow}[3]{\figraw{#2}{#1}{#3}{width=52mm}}
\newcommand{\fignarrowanon}[3]{\figrawanon{#2}{#1}{#3}{width=52mm}}
\newcommand{\fignarrowpathanon}[4]{\figrawpathanon{#2}{#1}{#3}{width=52mm}}
\newcommand{\fignarrowpath}[4]{\figrawpath{#2}{#1}{#3}{width=52mm}{#4}}
\newcommand{\figwide}[3]{\figrawwide{#2}{#1}{#3}{width=152mm}}
\newcommand{\figwideanon}[3]{\figrawwideanon{#2}{#1}{#3}{width=152mm}}
\newcommand{\figwidepath}[3]{\figrawwidepath{#2}{#1}{#3}{width=152mm}{#1}}
\newcommand{\figwidepathanon}[3]{\figrawwidepathanon{#2}{#1}{#3}{width=152mm}{#1}}
%\newcommand{\fignarrow}[3]{}
\newcommand{\figref}[1]{\ref{fig:#1}}
%%%%%%%%%%%%%%%%% problems %%%%%%%%%%%%%%%%%%%
\newenvironment{hwsection}{
    \vfill\clearpage
    \setcounter{secnumdepth}{0}          % Don't number this section.
    \section{Problems}
    \setcounter{secnumdepth}{2}          % Start numbering sections again.
}%
{%
    \vfill
}
\newcommand{\hwremark}[1]{\par\noindent\footnotesize{\textit{Remark:\/} #1}}
\newcommand{\hwtriangle}{$\triangleright$}
\newcommand{\hwsoln}{\hwaddtrailingstuff{\hwtriangle\ Solution, p. \pageref{soln:\currenthwlabel}}}
\newcommand{\answercheck}{\hwaddtrailingstuff{\hwcheckmark}}
\newcommand{\hwcheckmark}{\scriptsize\raisebox{1mm}{$\surd$}\normalsize}
\newcommand{\hwendpart}[1][3]{\hwflushtrailingstuff[#1]\\}
%	The optional argument ends up being passed to \nolinebreak. It defaults to 3, but
%	you can make it 2 or 4 if it seems to be making the wrong decision.
%   If there is only one part to the problem, or if you're fiddling with the very last
%   part of a multipart problem, I think you can add a gratuitous \hwendpart, but
%   except in this situation, don't do \hwendpart after the last part, because sometimes
%   it causes extra blank lines to appear.
%
\newcommand{\hwfill}[1]{\hspace*{\fill}\nolinebreak[#1]\nopagebreak[1]\hspace*{\fill}}
% ... cf LaTeX Companion, p. 443
\newcommand{\hwdifficulty}{0}
% ... This needs to be a global variable because I only display the symbol in  \end{hw},
%     which doesn't have access to #1.
\newcommand{\displayhwdifficulty}[1]{\ifthenelse{\equal{#1}{0}}{}{\ifthenelse{\equal{#1}{1}}{$\star$}{\ifthenelse{\equal{#1}{2}}{$\star\star$}{\ifthenelse{\equal{#1}{3}}{$\star\star\star$}{x}}}}} % qwe
\newsavebox{\hwtrailingstuff}
% There is also a boolean register, hwhavetrailing, defined under AtBeginDocument.
%
% The homework problem section is supposed to be like any other section, but not numbered.
% addtocontents: see Lamport, p. 176
\newcommand{\currenthwlabel}{}
\newcommand{\hwflushtrailingstuff}[1][3]{\ifthenelse{\boolean{hwhavetrailing}}{\hwfill{#1}\usebox{\hwtrailingstuff}\hwcleartrailingstuff}{}}
%
\newcommand{\hwcleartrailingstuff}{\sbox{\hwtrailingstuff}{}\setboolean{hwhavetrailing}{false}}
%
\newcommand{\hwaddtrailingstuff}[1]{\sbox{\hwtrailingstuff}{\usebox{\hwtrailingstuff}\quad{}#1}%
                                             \setboolean{hwhavetrailing}{true}}
%
\newenvironment{hw}[4]
       % #1=name, #2=difficulty, #3=calc, #4=label (e.g., a3)
       % based on the homeworkforcelabel environment in lmcommon.sty
       {%\begin{samepage}
          \renewcommand{\@currentlabel}{#4}\label{hw:#1}\noindent\textbf{#4}%
          \renewcommand{\currenthwlabel}{#4}
          \renewcommand{\hwdifficulty}{#2}%
          \quad%
        }
        {%
           \hwaddtrailingstuff{%
                                \displayhwdifficulty{\hwdifficulty}
                            }%
           \hwflushtrailingstuff\par%
           \vspace{\stretch{1}}%
                    % Put any available extra whitespace between problems.
                    % Half as big as what's generated by hw_block().
           \timetraveltohere
           %\end{samepage}
        }
%
%%%%%%%%%%%%%%%%% answers %%%%%%%%%%%%%%%%%%%
\newcommand{\solnhdr}[1]{\noindent\textbf{#1}\quad}
\newcommand{\ifchunk}[2]{#2}
\newenvironment{forcesoln}[4]{%
  % #1 is ignored
  \begin{figure*}
  \noindent\textbf{Problem \ref{hw:#4}:}\par
  #2
  \begin{forcetable}{#3}
}{%
  \end{forcetable}
  \end{figure*}
}
\newenvironment{forcetable}[1]{
  \par\noindent\begin{tabular}{|lll|lll|}
  \hline
  & & & \multicolumn{3}{c|}{\emph{equal and opposite force}} \\
  \multicolumn{3}{|c|}{\emph{force acting on #1}} &
  \multicolumn{3}{c|}{\emph{involved in Newton's 3rd law}} \\
  \hline
  \emph{type of} &                & \emph{object exerting} & {} & {} & \emph{object}  \\ 
  \emph{force}	& \emph{direction} & \emph{the force}        & \emph{type}	& \emph{direction} &\emph{exerting it} \\
  \hline
}{%
  \hline
  \end{tabular}
}
%%%%%%%%%%%%%%%%% titlesec %%%%%%%%%%%%%%%%%%%
\titleformat{\chapter}
  {\normalfont\huge\bfseries}
  {\thechapter}{1em}{}
\titleformat{\subsection}
  {\normalfont\large\itshape}
  {}{0em}{}
%========================= AtBeginDocument stuff=========================
\AtBeginDocument{
  \newboolean{hwhavetrailing}
}
